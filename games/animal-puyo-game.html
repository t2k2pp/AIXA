<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂãïÁâ©ÁµµÊñáÂ≠ó„Å∑„Çà„Å∑„Çà„Ç≤„Éº„É†</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f8ff;
            color: #333;
        }
        
        .game-container {
            display: flex;
            gap: 20px;
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .score-display {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .next-piece {
            width: 120px;
            height: 120px;
            border: 2px solid #333;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .next-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .next-container {
            font-size: 32px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        .instructions {
            width: 200px;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            background-color: #fff;
        }
        
        h1 {
            color: #4a6fb5;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #game-board {
            border: 2px solid #333;
            display: grid;
            grid-template-columns: repeat(6, 50px);
            grid-template-rows: repeat(12, 50px);
            gap: 1px;
            padding: 2px;
            background-color: #eee;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .cell {
            width: 50px;
            height: 50px;
            background-color: #fff;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4a6fb5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3a5a99;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        
        .highlight {
            animation: pop 0.5s ease-out;
        }
        
        @keyframes pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .falling {
            opacity: 0.9;
        }
        
        .chain-counter {
            position: absolute;
            font-size: 36px;
            font-weight: bold;
            color: #ff5722;
            text-shadow: 2px 2px 0 white;
            z-index: 10;
            animation: flyUp 1s ease-out forwards;
        }
        
        @keyframes flyUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>
    <h1>ÂãïÁâ©ÁµµÊñáÂ≠ó„Å∑„Çà„Å∑„Çà„Ç≤„Éº„É†</h1>
    
    <div class="game-container">
        <div class="game-info">
            <div class="score-display">
                „Çπ„Ç≥„Ç¢: <span id="score">0</span>
            </div>
            
            <div class="next-piece">
                <div class="next-title">Ê¨°„ÅÆ„Å∑„Çà</div>
                <div class="next-container" id="next-container"></div>
            </div>
            
            <div class="instructions">
                <h3>Êìç‰ΩúÊñπÊ≥ï:</h3>
                <p>‚¨ÖÔ∏è ‚û°Ô∏è: Â∑¶Âè≥ÁßªÂãï</p>
                <p>‚¨áÔ∏è: ‰∏ã„Å´ÁßªÂãï</p>
                <p>‚¨ÜÔ∏è: ÂõûËª¢</p>
                <p>„Çπ„Éö„Éº„Çπ: Âç≥ËêΩ‰∏ã</p>
            </div>
        </div>
        
        <div id="game-board"></div>
    </div>
    
    <div class="controls">
        <button id="start-button">„Ç≤„Éº„É†ÈñãÂßã</button>
        <button id="pause-button">‰∏ÄÊôÇÂÅúÊ≠¢</button>
    </div>
    
    <div class="game-over" id="game-over">
        <h2>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h2>
        <p>„Çπ„Ç≥„Ç¢: <span id="final-score">0</span></p>
        <button id="restart-button">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
    </div>
    
    <script>
        // „Ç≤„Éº„É†Ë®≠ÂÆö
        const BOARD_ROWS = 12;
        const BOARD_COLS = 6;
        const ANIMALS = ['üê∂', 'üê±', 'üê∞', 'üêº', 'ü¶ä'];
        const EMPTY = '';
        
        // „Ç≤„Éº„É†Áä∂ÊÖã
        let board = [];
        let currentPiece = null;
        let nextPiece = null;
        let score = 0;
        let gameInterval = null;
        let isPaused = false;
        let isGameOver = false;
        let chainCount = 0;
        let isAnimating = false;
        
        // DOMË¶ÅÁ¥†
        const gameBoard = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('final-score');
        const gameOverDisplay = document.getElementById('game-over');
        const startButton = document.getElementById('start-button');
        const pauseButton = document.getElementById('pause-button');
        const restartButton = document.getElementById('restart-button');
        const nextContainer = document.getElementById('next-container');
        
        // „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅÆÂàùÊúüÂåñ
        function initializeBoard() {
            gameBoard.innerHTML = '';
            board = [];
            
            for (let row = 0; row < BOARD_ROWS; row++) {
                const boardRow = [];
                
                for (let col = 0; col < BOARD_COLS; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    gameBoard.appendChild(cell);
                    boardRow.push(EMPTY);
                }
                
                board.push(boardRow);
            }
        }
        
        // „Å∑„Çà„Éö„Ç¢„ÅÆÁîüÊàê
        function createPiece() {
            if (nextPiece) {
                currentPiece = nextPiece;
            } else {
                currentPiece = {
                    shape: [
                        getRandomAnimal(),
                        getRandomAnimal()
                    ],
                    position: { row: 0, col: 2 },
                    orientation: 0 // 0: Á∏¶, 1: Âè≥, 2: ‰∏ã, 3: Â∑¶
                };
            }
            
            nextPiece = {
                shape: [
                    getRandomAnimal(),
                    getRandomAnimal()
                ],
                position: { row: 0, col: 2 },
                orientation: 0
            };
            
            updateNextPieceDisplay();
            
            // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            if (!isValidMove(currentPiece)) {
                endGame();
                return false;
            }
            
            return true;
        }
        
        // Ê¨°„ÅÆ„Å∑„ÇàË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateNextPieceDisplay() {
            nextContainer.innerHTML = '';
            const top = document.createElement('div');
            top.textContent = nextPiece.shape[0];
            const bottom = document.createElement('div');
            bottom.textContent = nextPiece.shape[1];
            
            nextContainer.appendChild(top);
            nextContainer.appendChild(document.createElement('div'));
            nextContainer.appendChild(bottom);
            nextContainer.appendChild(document.createElement('div'));
        }
        
        // „É©„É≥„ÉÄ„É†„Å™ÂãïÁâ©„ÇíÂèñÂæó
        function getRandomAnimal() {
            return ANIMALS[Math.floor(Math.random() * ANIMALS.length)];
        }
        
        // ÁèæÂú®„ÅÆ„Å∑„Çà„ÇíÊèèÁîª
        function drawPiece() {
            clearPiece();
            const positions = getPiecePositions(currentPiece);
            
            positions.forEach((pos, index) => {
                if (pos.row >= 0 && pos.row < BOARD_ROWS && pos.col >= 0 && pos.col < BOARD_COLS) {
                    const cell = document.querySelector(`.cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    cell.textContent = currentPiece.shape[index];
                    cell.classList.add('falling');
                }
            });
        }
        
        // ÁèæÂú®„ÅÆ„Å∑„Çà„Çí„ÇØ„É™„Ç¢
        function clearPiece() {
            document.querySelectorAll('.falling').forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('falling');
            });
        }
        
        // „Å∑„Çà„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
        function getPiecePositions(piece) {
            const positions = [];
            const { row, col } = piece.position;
            
            // ÊúÄÂàù„ÅÆ„Å∑„Çà„ÅØÂ∏∏„Å´Âêå„Åò‰ΩçÁΩÆ
            positions.push({ row, col });
            
            // 2Áï™ÁõÆ„ÅÆ„Å∑„Çà„ÅØÂêë„Åç„Å´„Çà„Å£„Å¶Áï∞„Å™„Çã
            switch (piece.orientation) {
                case 0: // ‰∏ä„Åã„Çâ2„Å§ÁõÆ„ÅÆ„Å∑„Çà„Åå‰∏ã
                    positions.push({ row: row + 1, col });
                    break;
                case 1: // ‰∏ä„Åã„Çâ2„Å§ÁõÆ„ÅÆ„Å∑„Çà„ÅåÂè≥
                    positions.push({ row, col: col + 1 });
                    break;
                case 2: // ‰∏ä„Åã„Çâ2„Å§ÁõÆ„ÅÆ„Å∑„Çà„Åå‰∏ä
                    positions.push({ row: row - 1, col });
                    break;
                case 3: // ‰∏ä„Åã„Çâ2„Å§ÁõÆ„ÅÆ„Å∑„Çà„ÅåÂ∑¶
                    positions.push({ row, col: col - 1 });
                    break;
            }
            
            return positions;
        }
        
        // ÁßªÂãï„ÅÆÊúâÂäπÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
        function isValidMove(piece) {
            const positions = getPiecePositions(piece);
            
            return positions.every(pos => {
                return (
                    pos.row >= 0 &&
                    pos.col >= 0 &&
                    pos.col < BOARD_COLS &&
                    pos.row < BOARD_ROWS &&
                    (pos.row < 0 || board[pos.row][pos.col] === EMPTY)
                );
            });
        }
        
        // „Å∑„Çà„Çí‰∏ã„Å´ÁßªÂãï
        function moveDown() {
            if (isAnimating) return;
            
            const newPiece = {
                ...currentPiece,
                position: {
                    row: currentPiece.position.row + 1,
                    col: currentPiece.position.col
                }
            };
            
            if (isValidMove(newPiece)) {
                currentPiece = newPiece;
                drawPiece();
                return true;
            } else {
                placePiece();
                return false;
            }
        }
        
        // „Å∑„Çà„ÇíÂ∑¶Âè≥„Å´ÁßªÂãï
        function moveHorizontal(direction) {
            if (isAnimating) return;
            
            const newPiece = {
                ...currentPiece,
                position: {
                    row: currentPiece.position.row,
                    col: currentPiece.position.col + direction
                }
            };
            
            if (isValidMove(newPiece)) {
                currentPiece = newPiece;
                drawPiece();
            }
        }
        
        // „Å∑„Çà„ÇíÂç≥ËêΩ‰∏ã
        function hardDrop() {
            if (isAnimating) return;
            
            while (moveDown()) {
                // „Å∑„Çà„ÅåÂ∫ï„Å´ÁùÄ„Åè„Åæ„ÅßÁπ∞„ÇäËøî„Åó
            }
        }
        
        // „Å∑„Çà„ÇíÂõûËª¢
        function rotatePiece() {
            if (isAnimating) return;
            
            const newPiece = {
                ...currentPiece,
                orientation: (currentPiece.orientation + 1) % 4
            };
            
            // ÂõûËª¢„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (isValidMove(newPiece)) {
                currentPiece = newPiece;
                drawPiece();
                return;
            }
            
            // Â£Å„Ç≠„ÉÉ„ÇØ„ÅÆË©¶Ë°å
            const wallKicks = [
                { row: 0, col: -1 }, // Â∑¶„Å´ÁßªÂãï
                { row: 0, col: 1 },  // Âè≥„Å´ÁßªÂãï
                { row: -1, col: 0 }, // ‰∏ä„Å´ÁßªÂãï
                { row: 1, col: 0 }   // ‰∏ã„Å´ÁßªÂãï
            ];
            
            for (const kick of wallKicks) {
                const kickedPiece = {
                    ...newPiece,
                    position: {
                        row: newPiece.position.row + kick.row,
                        col: newPiece.position.col + kick.col
                    }
                };
                
                if (isValidMove(kickedPiece)) {
                    currentPiece = kickedPiece;
                    drawPiece();
                    return;
                }
            }
        }
        
        // „Å∑„Çà„Çí„Éú„Éº„Éâ„Å´ÈÖçÁΩÆ
        function placePiece() {
            const positions = getPiecePositions(currentPiece);
            
            positions.forEach((pos, index) => {
                if (pos.row >= 0 && pos.row < BOARD_ROWS && pos.col >= 0 && pos.col < BOARD_COLS) {
                    board[pos.row][pos.col] = currentPiece.shape[index];
                    const cell = document.querySelector(`.cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    cell.textContent = currentPiece.shape[index];
                    cell.classList.remove('falling');
                }
            });
            
            checkForMatches();
        }
        
        // „Éú„Éº„Éâ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateBoard() {
            for (let row = 0; row < BOARD_ROWS; row++) {
                for (let col = 0; col < BOARD_COLS; col++) {
                    const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                    cell.textContent = board[row][col];
                    cell.classList.remove('falling');
                }
            }
        }
        
        // Èö£Êé•„Åô„ÇãÂêå„ÅòÂãïÁâ©„ÇíÊé¢Á¥¢
        function findConnectedGroups() {
            const visited = Array(BOARD_ROWS).fill().map(() => Array(BOARD_COLS).fill(false));
            const groups = [];
            
            for (let row = 0; row < BOARD_ROWS; row++) {
                for (let col = 0; col < BOARD_COLS; col++) {
                    if (board[row][col] !== EMPTY && !visited[row][col]) {
                        const group = [];
                        const animal = board[row][col];
                        
                        // Ê∑±„ÅïÂÑ™ÂÖàÊé¢Á¥¢„ÅßÂêå„ÅòÂãïÁâ©„ÇíÊé¢„Åô
                        function dfs(r, c) {
                            if (
                                r < 0 || r >= BOARD_ROWS || 
                                c < 0 || c >= BOARD_COLS || 
                                visited[r][c] || 
                                board[r][c] !== animal
                            ) {
                                return;
                            }
                            
                            visited[r][c] = true;
                            group.push({ row: r, col: c });
                            
                            // 4ÊñπÂêë„ÇíÊé¢Á¥¢
                            dfs(r + 1, c); // ‰∏ã
                            dfs(r - 1, c); // ‰∏ä
                            dfs(r, c + 1); // Âè≥
                            dfs(r, c - 1); // Â∑¶
                        }
                        
                        dfs(row, col);
                        
                        if (group.length >= 4) {
                            groups.push(group);
                        }
                    }
                }
            }
            
            return groups;
        }
        
        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkForMatches() {
            const groups = findConnectedGroups();
            
            if (groups.length > 0) {
                isAnimating = true;
                chainCount++;
                
                // „Éû„ÉÉ„ÉÅ„Åó„Åü„Å∑„Çà„Å´ÂäπÊûú„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ©Áî®
                groups.forEach(group => {
                    group.forEach(pos => {
                        const cell = document.querySelector(`.cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                        cell.classList.add('highlight');
                        
                        // „Éù„Ç§„É≥„ÉàË®àÁÆó
                        const basePoints = 10;
                        const groupBonus = group.length - 3; // 4ÂÄã‰ª•‰∏ä„ÅßËøΩÂä†„Éù„Ç§„É≥„Éà
                        const chainBonus = chainCount - 1;   // 2ÈÄ£Èéñ‰ª•‰∏ä„Åß„Éú„Éº„Éä„Çπ
                        let points = basePoints + (groupBonus * 5) + (chainBonus * 20);
                        
                        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
                        score += points;
                        scoreDisplay.textContent = score;
                    });
                });
                
                // ÈÄ£ÈéñË°®Á§∫
                if (chainCount > 1) {
                    const chainDisplay = document.createElement('div');
                    chainDisplay.classList.add('chain-counter');
                    chainDisplay.textContent = `${chainCount}ÈÄ£ÈéñÔºÅ`;
                    chainDisplay.style.left = `${Math.random() * 300 + 100}px`;
                    chainDisplay.style.top = `${Math.random() * 200 + 100}px`;
                    document.body.appendChild(chainDisplay);
                    
                    setTimeout(() => {
                        document.body.removeChild(chainDisplay);
                    }, 1000);
                }
                
                // Ê∂à„Åà„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´Âá¶ÁêÜ
                setTimeout(() => {
                    // „Éû„ÉÉ„ÉÅ„Åó„Åü„Å∑„Çà„ÇíÊ∂à„Åô
                    groups.forEach(group => {
                        group.forEach(pos => {
                            board[pos.row][pos.col] = EMPTY;
                        });
                    });
                    
                    updateBoard();
                    
                    // ÈáçÂäõ„ÅÆÈÅ©Áî®
                    applyGravity();
                    
                    // Ê¨°„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    setTimeout(() => {
                        if (!checkForMatches()) {
                            isAnimating = false;
                            chainCount = 0;
                            if (!createPiece()) return;
                            drawPiece();
                        }
                    }, 500);
                }, 500);
                
                return true;
            } else {
                chainCount = 0;
                if (!createPiece()) return;
                drawPiece();
                return false;
            }
        }
        
        // ÈáçÂäõ„ÇíÈÅ©Áî®Ôºà„Å∑„Çà„Çí‰∏ã„Å´ËêΩ„Å®„ÅôÔºâ
        function applyGravity() {
            let moved = false;
            
            for (let col = 0; col < BOARD_COLS; col++) {
                for (let row = BOARD_ROWS - 2; row >= 0; row--) {
                    if (board[row][col] !== EMPTY && board[row + 1][col] === EMPTY) {
                        let currentRow = row;
                        
                        // Á©∫ÁôΩ„Åå„ÅÇ„ÇãÈôê„Çä‰∏ã„Å´ÁßªÂãï
                        while (
                            currentRow + 1 < BOARD_ROWS && 
                            board[currentRow + 1][col] === EMPTY
                        ) {
                            board[currentRow + 1][col] = board[currentRow][col];
                            board[currentRow][col] = EMPTY;
                            currentRow++;
                            moved = true;
                        }
                    }
                }
            }
            
            if (moved) {
                updateBoard();
            }
            
            return moved;
        }
        
        // „Ç≤„Éº„É†„ÇíÈñãÂßã
        function startGame() {
            if (gameInterval) return;
            
            initializeBoard();
            score = 0;
            scoreDisplay.textContent = score;
            isGameOver = false;
            isPaused = false;
            chainCount = 0;
            isAnimating = false;
            
            gameOverDisplay.style.display = 'none';
            createPiece();
            drawPiece();
            
            gameInterval = setInterval(() => {
                if (!isPaused && !isAnimating) {
                    moveDown();
                }
            }, 500);
        }
        
        // „Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢/ÂÜçÈñã
        function togglePause() {
            if (isGameOver) return;
            
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? '„Ç≤„Éº„É†ÂÜçÈñã' : '‰∏ÄÊôÇÂÅúÊ≠¢';
        }
        
        // „Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü
        function endGame() {
            clearInterval(gameInterval);
            gameInterval = null;
            isGameOver = true;
            finalScoreDisplay.textContent = score;
            gameOverDisplay.style.display = 'block';
        }
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
        document.addEventListener('keydown', (event) => {
            if (isGameOver || isPaused) return;
            
            switch (event.key) {
                case 'ArrowLeft':
                    moveHorizontal(-1);
                    break;
                case 'ArrowRight':
                    moveHorizontal(1);
                    break;
                case 'ArrowDown':
                    moveDown();
                    break;
                case 'ArrowUp':
                    rotatePiece();
                    break;
                case ' ': // „Çπ„Éö„Éº„Çπ„Ç≠„Éº
                    event.preventDefault();
                    hardDrop();
                    break;
            }
        });
        
        // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
        startButton.addEventListener('click', startGame);
        pauseButton.addEventListener('click', togglePause);
        restartButton.addEventListener('click', startGame);
        
        // ÂàùÊúüË°®Á§∫
        initializeBoard();
    </script>
</body>
</html>