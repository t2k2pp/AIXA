<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ¬ã‚¤ã‚º9Ã—9ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </title>
    <style>
        /* åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* èƒŒæ™¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ã®ã‚¯ãƒ©ã‚¹ */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠç”»é¢ */
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .player-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .player-card.child1 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .player-card.child2 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .player-card.adult1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .player-card.adult2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        /* é›£æ˜“åº¦é¸æŠ */
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .difficulty-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-btn.easy { background: #4ecdc4; color: white; }
        .difficulty-btn.normal { background: #ffd93d; color: #333; }
        .difficulty-btn.hard { background: #ff6b6b; color: white; }

        .difficulty-btn:hover {
            transform: scale(1.05);
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .score-display {
            background: linear-gradient(45deg, #43a047, #66bb6a);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }

        .timer-display {
            background: linear-gradient(45deg, #e53935, #ef5350);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }

        /* ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 2px;
            background: #333;
            border-radius: 10px;
            padding: 10px;
            margin: 20px auto;
            max-width: 450px;
        }

        .cell {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .cell:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .cell.selected {
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }

        /* è‰²åˆ¥ã®ã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .cell.color-0 { background: linear-gradient(45deg, #e91e63, #f06292); }
        .cell.color-1 { background: linear-gradient(45deg, #2196f3, #64b5f6); }
        .cell.color-2 { background: linear-gradient(45deg, #4caf50, #81c784); }
        .cell.color-3 { background: linear-gradient(45deg, #ff9800, #ffb74d); }
        .cell.color-4 { background: linear-gradient(45deg, #9c27b0, #ba68c8); }
        .cell.color-5 { background: linear-gradient(45deg, #00bcd4, #4dd0e1); }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ */
        .final-score {
            font-size: 2em;
            color: #4caf50;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .high-score-display {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 0.6s ease;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 600px) {
            .game-container {
                padding: 20px;
                margin: 10px;
            }
            
            .game-board {
                max-width: 350px;
            }
            
            .cell {
                font-size: 16px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen" class="screen active">
            <h1>ğŸ® ã‚¢ãƒ¬ã‚¤ã‚º9Ã—9</h1>
            <p>åŒã˜è‰²ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’3ã¤ä»¥ä¸Šä¸¦ã¹ã¦æ¶ˆãã†ï¼</p>
            <button class="btn" onclick="showPlayerSelect()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <div class="high-score-display">
                <h3>ğŸ† ãƒã‚¤ã‚¹ã‚³ã‚¢ ğŸ†</h3>
                <div id="high-scores-display"></div>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠç”»é¢ -->
        <div id="player-select-screen" class="screen">
            <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã‚“ã§ã­ï¼</h2>
            <div class="player-grid">
                <button class="player-card child1" onclick="selectPlayer('child1', 'ã‚†ã†ã')">
                    ğŸ‘¦<br>ã‚†ã†ã<br>(ã“ã©ã‚‚)
                </button>
                <button class="player-card child2" onclick="selectPlayer('child2', 'ã¿ã‚†')">
                    ğŸ‘§<br>ã¿ã‚†<br>(ã“ã©ã‚‚)
                </button>
                <button class="player-card adult1" onclick="selectPlayer('adult1', 'ãŠã¨ã†ã•ã‚“')">
                    ğŸ‘¨<br>ãŠã¨ã†ã•ã‚“<br>(ãŠã¨ãª)
                </button>
                <button class="player-card adult2" onclick="selectPlayer('adult2', 'ãŠã‹ã‚ã•ã‚“')">
                    ğŸ‘©<br>ãŠã‹ã‚ã•ã‚“<br>(ãŠã¨ãª)
                </button>
            </div>
            <button class="btn" onclick="showStartScreen()">ã‚‚ã©ã‚‹</button>
        </div>

        <!-- é›£æ˜“åº¦é¸æŠç”»é¢ -->
        <div id="difficulty-screen" class="screen">
            <h2 id="difficulty-player-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</h2>
            <p>é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã­ï¼</p>
            <div class="difficulty-buttons">
                <button class="difficulty-btn easy" onclick="startGame('easy')">
                    ğŸ˜Š ã‹ã‚“ãŸã‚“<br>90ç§’
                </button>
                <button class="difficulty-btn normal" onclick="startGame('normal')">
                    ğŸ˜ ãµã¤ã†<br>60ç§’
                </button>
                <button class="difficulty-btn hard" onclick="startGame('hard')">
                    ğŸ˜¤ ã‚€ãšã‹ã—ã„<br>30ç§’
                </button>
            </div>
            <button class="btn" onclick="showPlayerSelect()">ã‚‚ã©ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div class="score-display">
                    ã‚¹ã‚³ã‚¢: <span id="current-score">0</span>
                </div>
                <div id="current-player-display" class="score-display"></div>
                <div class="timer-display">
                    æ™‚é–“: <span id="timer">60</span>ç§’
                </div>
            </div>
            <div id="game-board" class="game-board"></div>
            <button class="btn" onclick="pauseGame()">ãƒãƒ¼ã‚º</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ -->
        <div id="game-over-screen" class="screen">
            <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
            <div class="final-score">
                æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span>ç‚¹
            </div>
            <div id="high-score-message"></div>
            <div class="high-score-display">
                <span id="player-high-score"></span>
            </div>
            <button class="btn" onclick="confirmScore()">ã‚¹ã‚³ã‚¢ã‚’ç¢ºèª</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
        let gameState = {
            currentPlayer: null,
            currentPlayerName: '',
            difficulty: 'normal',
            score: 0,
            timeLeft: 60,
            board: [],
            selectedCell: null,
            gameActive: false,
            timer: null
        };

        // ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°ï¼ˆãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ï¼‰
        let highScores = {
            child1: 0,
            child2: 0,
            adult1: 0,
            adult2: 0
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®å®šç¾©
        const playerNames = {
            child1: 'ã‚†ã†ã',
            child2: 'ã¿ã‚†',
            adult1: 'ãŠã¨ã†ã•ã‚“',
            adult2: 'ãŠã‹ã‚ã•ã‚“'
        };

        // è‰²ã®ç¨®é¡ï¼ˆ6è‰²ï¼‰
        const colors = ['ğŸŸ¥', 'ğŸŸ¦', 'ğŸŸ©', 'ğŸŸ¨', 'ğŸŸª', 'ğŸŸ«'];

        /**
         * ã‚²ãƒ¼ãƒ åˆæœŸåŒ–æ™‚ã«ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
         */
        function updateHighScoreDisplay() {
            const display = document.getElementById('high-scores-display');
            let html = '';
            Object.keys(playerNames).forEach(playerId => {
                const name = playerNames[playerId];
                const score = highScores[playerId];
                html += `${name}: ${score}ç‚¹<br>`;
            });
            display.innerHTML = html;
        }

        /**
         * ç”»é¢åˆ‡ã‚Šæ›¿ãˆã®å…±é€šé–¢æ•°
         */
        function showScreen(screenId) {
            // ã™ã¹ã¦ã®ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
            document.getElementById(screenId).classList.add('active');
        }

        /**
         * ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
         */
        function showStartScreen() {
            updateHighScoreDisplay();
            showScreen('start-screen');
        }

        /**
         * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠç”»é¢ã‚’è¡¨ç¤º
         */
        function showPlayerSelect() {
            showScreen('player-select-screen');
        }

        /**
         * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦é›£æ˜“åº¦é¸æŠç”»é¢ã¸
         */
        function selectPlayer(playerId, playerName) {
            gameState.currentPlayer = playerId;
            gameState.currentPlayerName = playerName;
            
            document.getElementById('difficulty-player-name').textContent = 
                `${playerName}ã®é›£æ˜“åº¦é¸æŠ`;
            
            showScreen('difficulty-screen');
        }

        /**
         * ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
         */
        function initializeBoard() {
            gameState.board = [];
            
            // 9x9ã®ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆ
            for (let row = 0; row < 9; row++) {
                gameState.board[row] = [];
                for (let col = 0; col < 9; col++) {
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’é…ç½®ï¼ˆåˆæœŸçŠ¶æ…‹ã§3ã¤ä»¥ä¸Šä¸¦ã°ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
                    let color;
                    do {
                        color = Math.floor(Math.random() * 6);
                    } while (wouldCreateMatch(row, col, color));
                    
                    gameState.board[row][col] = color;
                }
            }
        }

        /**
         * æŒ‡å®šä½ç½®ã«è‰²ã‚’ç½®ã„ãŸå ´åˆã€3ã¤ä»¥ä¸Šä¸¦ã¶ã‹ãƒã‚§ãƒƒã‚¯
         */
        function wouldCreateMatch(row, col, color) {
            // æ°´å¹³æ–¹å‘ã®ãƒã‚§ãƒƒã‚¯
            let horizontalCount = 1;
            
            // å·¦æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯
            for (let c = col - 1; c >= 0 && gameState.board[row] && gameState.board[row][c] === color; c--) {
                horizontalCount++;
            }
            
            // å³æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯
            for (let c = col + 1; c < 9 && gameState.board[row] && gameState.board[row][c] === color; c++) {
                horizontalCount++;
            }
            
            if (horizontalCount >= 3) return true;
            
            // å‚ç›´æ–¹å‘ã®ãƒã‚§ãƒƒã‚¯
            let verticalCount = 1;
            
            // ä¸Šæ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯
            for (let r = row - 1; r >= 0 && gameState.board[r] && gameState.board[r][col] === color; r--) {
                verticalCount++;
            }
            
            // ä¸‹æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯
            for (let r = row + 1; r < 9 && gameState.board[r] && gameState.board[r][col] === color; r++) {
                verticalCount++;
            }
            
            return verticalCount >= 3;
        }

        /**
         * ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã‚’HTMLã«æç”»
         */
        function renderBoard() {
            const boardElement = document.getElementById('game-board');
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell color-${gameState.board[row][col]}`;
                    cell.textContent = colors[gameState.board[row][col]];
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => cellClicked(row, col));
                    boardElement.appendChild(cell);
                }
            }
        }

        /**
         * ã‚»ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
         */
        function cellClicked(row, col) {
            if (!gameState.gameActive) return;
            
            const clickedCell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            
            if (gameState.selectedCell === null) {
                // æœ€åˆã®ã‚»ãƒ«é¸æŠ
                gameState.selectedCell = {row, col};
                clickedCell.classList.add('selected');
            } else {
                // 2ç•ªç›®ã®ã‚»ãƒ«é¸æŠ - äº¤æ›ã‚’è©¦ã¿ã‚‹
                const selected = gameState.selectedCell;
                
                // é¸æŠè§£é™¤
                document.querySelector('.selected')?.classList.remove('selected');
                
                // éš£æ¥ãƒã‚§ãƒƒã‚¯
                if (isAdjacent(selected.row, selected.col, row, col)) {
                    // ãƒ–ãƒ­ãƒƒã‚¯ã‚’äº¤æ›
                    swapBlocks(selected.row, selected.col, row, col);
                    
                    // ãƒãƒƒãƒã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å‡¦ç†
                    if (checkAndRemoveMatches()) {
                        // ãƒãƒƒãƒãŒã‚ã£ãŸå ´åˆã€è½ä¸‹å‡¦ç†ã‚’è¡Œã†
                        dropBlocks();
                    } else {
                        // ãƒãƒƒãƒãŒãªã‹ã£ãŸå ´åˆã€äº¤æ›ã‚’å…ƒã«æˆ»ã™
                        swapBlocks(selected.row, selected.col, row, col);
                    }
                }
                
                gameState.selectedCell = null;
            }
        }

        /**
         * 2ã¤ã®ã‚»ãƒ«ãŒéš£æ¥ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
         */
        function isAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }

        /**
         * 2ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’äº¤æ›
         */
        function swapBlocks(row1, col1, row2, col2) {
            const temp = gameState.board[row1][col1];
            gameState.board[row1][col1] = gameState.board[row2][col2];
            gameState.board[row2][col2] = temp;
            renderBoard();
        }

        /**
         * ãƒãƒƒãƒã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å‰Šé™¤
         */
        function checkAndRemoveMatches() {
            const toRemove = [];
            
            // æ°´å¹³æ–¹å‘ã®ãƒãƒƒãƒã‚’ãƒã‚§ãƒƒã‚¯
            for (let row = 0; row < 9; row++) {
                let count = 1;
                let currentColor = gameState.board[row][0];
                
                for (let col = 1; col < 9; col++) {
                    if (gameState.board[row][col] === currentColor) {
                        count++;
                    } else {
                        if (count >= 3) {
                            for (let c = col - count; c < col; c++) {
                                toRemove.push({row, col: c});
                            }
                        }
                        count = 1;
                        currentColor = gameState.board[row][col];
                    }
                }
                
                // è¡Œã®æœ€å¾Œã‚’ãƒã‚§ãƒƒã‚¯
                if (count >= 3) {
                    for (let c = 9 - count; c < 9; c++) {
                        toRemove.push({row, col: c});
                    }
                }
            }
            
            // å‚ç›´æ–¹å‘ã®ãƒãƒƒãƒã‚’ãƒã‚§ãƒƒã‚¯
            for (let col = 0; col < 9; col++) {
                let count = 1;
                let currentColor = gameState.board[0][col];
                
                for (let row = 1; row < 9; row++) {
                    if (gameState.board[row][col] === currentColor) {
                        count++;
                    } else {
                        if (count >= 3) {
                            for (let r = row - count; r < row; r++) {
                                toRemove.push({row: r, col});
                            }
                        }
                        count = 1;
                        currentColor = gameState.board[row][col];
                    }
                }
                
                // åˆ—ã®æœ€å¾Œã‚’ãƒã‚§ãƒƒã‚¯
                if (count >= 3) {
                    for (let r = 9 - count; r < 9; r++) {
                        toRemove.push({row: r, col});
                    }
                }
            }
            
            // é‡è¤‡ã‚’é™¤å»
            const uniqueToRemove = toRemove.filter((pos, index, arr) => 
                arr.findIndex(p => p.row === pos.row && p.col === pos.col) === index
            );
            
            if (uniqueToRemove.length > 0) {
                // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆé›£æ˜“åº¦ã«ã‚ˆã‚‹å€ç‡é©ç”¨ï¼‰
                const multiplier = gameState.difficulty === 'easy' ? 1 : 
                                gameState.difficulty === 'normal' ? 2 : 3;
                gameState.score += uniqueToRemove.length * 10 * multiplier;
                
                // ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆ-1ã§ãƒãƒ¼ã‚¯ï¼‰
                uniqueToRemove.forEach(pos => {
                    gameState.board[pos.row][pos.col] = -1;
                });
                
                updateScore();
                return true;
            }
            
            return false;
        }

        /**
         * ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸‹ã«è½ã¨ã™
         */
        function dropBlocks() {
            for (let col = 0; col < 9; col++) {
                // å„åˆ—ã§å‰Šé™¤ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸‹ã«è©°ã‚ã‚‹
                let writeIndex = 8; // ä¸‹ã‹ã‚‰è©°ã‚ã¦ã„ã
                
                for (let row = 8; row >= 0; row--) {
                    if (gameState.board[row][col] !== -1) {
                        gameState.board[writeIndex][col] = gameState.board[row][col];
                        if (writeIndex !== row) {
                            gameState.board[row][col] = -1;
                        }
                        writeIndex--;
                    }
                }
                
                // ä¸Šã®ç©ºã„ãŸéƒ¨åˆ†ã«æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’é…ç½®
                for (let row = 0; row <= writeIndex; row++) {
                    gameState.board[row][col] = Math.floor(Math.random() * 6);
                }
            }
            
            renderBoard();
            
            // æ–°ã—ã„ãƒãƒƒãƒãŒã§ããŸå ´åˆã¯å†åº¦å‡¦ç†
            setTimeout(() => {
                if (checkAndRemoveMatches()) {
                    dropBlocks();
                }
            }, 300);
        }

        /**
         * ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
         */
        function updateScore() {
            document.getElementById('current-score').textContent = gameState.score;
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
         */
        function updateTimer() {
            document.getElementById('timer').textContent = gameState.timeLeft;
            
            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
         */
        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.score = 0;
            gameState.selectedCell = null;
            gameState.gameActive = true;
            
            // é›£æ˜“åº¦ã«å¿œã˜ã¦åˆ¶é™æ™‚é–“ã‚’è¨­å®š
            switch (difficulty) {
                case 'easy':
                    gameState.timeLeft = 90;
                    break;
                case 'normal':
                    gameState.timeLeft = 60;
                    break;
                case 'hard':
                    gameState.timeLeft = 30;
                    break;
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¡¨ç¤º
            document.getElementById('current-player-display').textContent = 
                gameState.currentPlayerName;
            
            // ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã—ã¦æç”»
            initializeBoard();
            renderBoard();
            updateScore();
            updateTimer();
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimer();
            }, 1000);
            
            showScreen('game-screen');
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢
         */
        function pauseGame() {
            if (gameState.gameActive) {
                gameState.gameActive = false;
                clearInterval(gameState.timer);
                alert('ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸã€‚OKã‚’æŠ¼ã™ã¨å†é–‹ã—ã¾ã™ã€‚');
                gameState.gameActive = true;
                gameState.timer = setInterval(() => {
                    gameState.timeLeft--;
                    updateTimer();
                }, 1000);
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ çµ‚äº†
         */
        function endGame() {
            gameState.gameActive = false;
            clearInterval(gameState.timer);
            
            // ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒã‚§ãƒƒã‚¯
            const currentHighScore = highScores[gameState.currentPlayer];
            let isNewHighScore = false;
            
            if (gameState.score > currentHighScore) {
                highScores[gameState.currentPlayer] = gameState.score;
                isNewHighScore = true;
            }
            
            // çµæœç”»é¢ã«æƒ…å ±ã‚’è¨­å®š
            document.getElementById('final-score').textContent = gameState.score;
            
            const highScoreMessage = document.getElementById('high-score-message');
            if (isNewHighScore) {
                highScoreMessage.innerHTML = '<h3 style="color: #ff6b6b;">ğŸ‰ æ–°è¨˜éŒ²é”æˆï¼ ğŸ‰</h3>';
                highScoreMessage.classList.add('bounce');
            } else {
                highScoreMessage.innerHTML = '';
                highScoreMessage.classList.remove('bounce');
            }
            
            document.getElementById('player-high-score').textContent = 
                `${gameState.currentPlayerName}ã®ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScores[gameState.currentPlayer]}ç‚¹`;
            
            showScreen('game-over-screen');
        }

        /**
         * ã‚¹ã‚³ã‚¢ç¢ºèªå¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
         */
        function confirmScore() {
            showStartScreen();
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’åˆæœŸåŒ–
        window.addEventListener('load', () => {
            updateHighScoreDisplay();
        });
    </script>
</body>
</html>